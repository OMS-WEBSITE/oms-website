---
import Layout from '../layouts/main.astro';
import { useState, useEffect } from "react";
import { Button } from '@/components/ui/button';
---

<Layout title="Admin Panel | Manage Jobs">
  <main class="min-h-screen bg-gray-50 py-10">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow">
      <h1 class="text-3xl font-bold mb-6 text-center">Admin Panel</h1>

      <!-- üîí Simple login section -->
      <div id="login-section">
        <form id="login-form" class="space-y-4 text-center">
          <input
            type="password"
            id="admin-password"
            placeholder="Enter Admin Password"
            class="border p-2 rounded w-64"
          />
          <Button id="login-btn" class="bg-orange-500 hover:bg-orange-600 text-white">
            Login
          </Button>
        </form>
      </div>

      <!-- üßæ Jobs management section -->
      <div id="admin-section" class="hidden">
        <h2 class="text-2xl font-semibold mb-4">Manage Jobs</h2>

        <form id="job-form" class="space-y-3 mb-8">
          <input type="text" id="title" placeholder="Job Title" class="border p-2 rounded w-full" />
          <input type="text" id="department" placeholder="Department" class="border p-2 rounded w-full" />
          <input type="text" id="location" placeholder="Location" class="border p-2 rounded w-full" />
          <input type="text" id="type" placeholder="Type (Full-time/Part-time)" class="border p-2 rounded w-full" />
          <input type="text" id="experience" placeholder="Experience (e.g. 3+ years)" class="border p-2 rounded w-full" />
          <input type="text" id="salary" placeholder="Salary (e.g. $100k - $130k)" class="border p-2 rounded w-full" />
          <textarea id="description" placeholder="Job Description" class="border p-2 rounded w-full"></textarea>
          <Button id="add-job" class="bg-blue-500 hover:bg-blue-600 text-white">Add Job</Button>
        </form>

        <h3 class="text-xl font-semibold mb-4">Existing Jobs</h3>
        <ul id="job-list" class="space-y-3"></ul>
      </div>
    </div>
  </main>

  <script>
    const PASSWORD = "admin123"; // Change this later to env variable if needed

    const loginSection = document.getElementById("login-section");
    const adminSection = document.getElementById("admin-section");
    const loginForm = document.getElementById("login-form");
    const jobList = document.getElementById("job-list");
    const addJobBtn = document.getElementById("add-job");

    // üîê Simple password protection
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const inputPass = document.getElementById("admin-password").value;
      if (inputPass === PASSWORD) {
        loginSection.classList.add("hidden");
        adminSection.classList.remove("hidden");
        fetchJobs();
      } else {
        alert("Incorrect password!");
      }
    });

    // üßæ Fetch jobs from API
    async function fetchJobs() {
      const res = await fetch("/api/getJobs");
      const jobs = await res.json();
      renderJobs(jobs);
    }

    // üß± Render job list
    function renderJobs(jobs) {
      jobList.innerHTML = "";
      jobs.forEach((job) => {
        const li = document.createElement("li");
        li.className = "p-3 border rounded flex justify-between items-center";
        li.innerHTML = `
          <div>
            <strong>${job.title}</strong> <span class="text-gray-500">(${job.department})</span>
          </div>
          <button class="text-red-500 hover:underline" onclick="deleteJob('${job.title}')">Delete</button>
        `;
        jobList.appendChild(li);
      });
    }

    // ‚ûï Add new job
    addJobBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      const job = {
        title: document.getElementById("title").value,
        department: document.getElementById("department").value,
        location: document.getElementById("location").value,
        type: document.getElementById("type").value,
        experience: document.getElementById("experience").value,
        salary: document.getElementById("salary").value,
        description: document.getElementById("description").value,
      };

      await fetch("/api/saveJob", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(job),
      });

      fetchJobs();
      alert("Job added successfully!");
      document.getElementById("job-form").reset();
    });

    // ‚ùå Delete job
    async function deleteJob(title) {
      if (confirm("Are you sure you want to delete this job?")) {
        await fetch("/api/deleteJob", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title }),
        });
        fetchJobs();
      }
    }

    window.deleteJob = deleteJob;
  </script>
</Layout>
